name: Build iOS IPA

on:
  workflow_dispatch: # allows manual trigger

jobs:
  build:
    runs-on: macos-latest

    steps:
    # 1️⃣ Checkout the repo
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Setup Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.6' # match your local version

    # 3️⃣ Get Flutter dependencies
    - name: Flutter Pub Get
      run: flutter pub get

    # 4️⃣ Clean previous builds
    - name: Flutter Clean
      run: flutter clean

    # 5️⃣ Install CocoaPods & update repo
    - name: Install CocoaPods
      run: |
        sudo gem install cocoapods
        cd ios
        pod repo update
        pod install --verbose
        cd ..

    # 6️⃣ Import your p12 & provisioning profile
    - name: Import Codesign Certificates
      uses: apple-actions/import-codesign-certs@v1
      with:
        keychain: signing_temp
        create-keychain: true
        keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}
        p12-file-base64: ${{ secrets.P12_BASE64 }}
        p12-password: ${{ secrets.P12_PASSWORD }}
        provisioning-profile-base64: ${{ secrets.PROV_PROFILE_BASE64 }}

    # 7️⃣ Build the iOS release IPA
    - name: Build iOS IPA
      run: |
        flutter build ipa --release --no-codesign=false

     # 8️⃣ Upload the IPA so you can download it
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: RudysHourly-iOS
        path: build/ios/ipa/Runner.ipa

